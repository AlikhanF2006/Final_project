<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Movie — Movie Platform</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f7fb;color:#111}
        header{background:#0b1220;color:#fff;padding:12px 20px;display:flex;align-items:center;gap:12px}
        header h1{margin:0;font-size:18px}
        .container{max-width:980px;margin:18px auto;padding:0 16px}
        .top{display:flex;gap:8px;align-items:center;margin-bottom:14px}
        input[type=text], input[type=number], input[type=email], input[type=password]{
            padding:8px;border-radius:6px;border:1px solid #d0d7de;
        }
        button{padding:8px 12px;border-radius:6px;border:0;background:#0ea5a4;color:#fff;cursor:pointer}
        .movie-wrap{display:flex;gap:18px;align-items:flex-start}
        .left{flex:1}
        .right{width:360px}
        iframe{width:100%;border-radius:6px;border:0}
        .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(14,20,30,0.06);margin-bottom:12px}
        .meta{color:#6b7280;font-size:13px}
        pre.json{background:#0f172a;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;font-size:12px}
        a.link{color:#0369a1;text-decoration:none}
        .small{font-size:13px;color:#6b7280}
        .reviews{margin-top:12px}
        .review{border-top:1px solid #eee;padding:8px 0}
    </style>
</head>
<body>
<header>
    <h1>Movie Platform</h1>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="searchInput" placeholder="Search title..." style="min-width:180px"/>
        <input id="searchYear" placeholder="Year" type="number" style="width:100px"/>
        <button id="searchBtn">Search</button>
        <a id="homeLink" class="link" href="/">Home</a>
        <div id="authArea"></div>
    </div>
</header>

<div class="container">
    <div id="content">
        <div class="card">
            <div id="movieMain">
                <h2 id="title">Loading...</h2>
                <div class="meta" id="meta"></div>
                <p id="desc"></p>
            </div>
        </div>

        <div class="movie-wrap">
            <div class="left">
                <div class="card">
                    <h3>Server movie data</h3>
                    <pre id="serverJson" class="json">loading...</pre>
                </div>

                <div id="reviewsBlock" class="card">
                    <h3>Reviews</h3>
                    <div id="reviewsList" class="reviews"></div>

                    <div style="margin-top:12px">
                        <h4>Add review (requires login)</h4>
                        <label>Score (1-5): <input id="revScore" type="number" min="1" max="5" value="5" style="width:80px"></label>
                        <button id="addReviewBtn">Add review</button>
                    </div>
                </div>
            </div>

            <div class="right">
                <div class="card">
                    <h4>Trailer</h4>
                    <div id="trailerContainer">
                        <div class="small">Loading trailer...</div>
                    </div>
                </div>

                <div class="card">
                    <h4>TMDB data</h4>
                    <pre id="tmdbJson" class="json">loading...</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (async function(){
        // Helpers
        function qs(name){
            const url = new URL(location.href);
            return url.searchParams.get(name);
        }
        function toJsonText(obj){ return JSON.stringify(obj, null, 2) }

        // Extract params: prefer id (server DB id), else tmdb
        const serverId = qs('id');         // /movie.html?id=123
        const tmdbParam = qs('tmdb');      // /movie.html?tmdb=550

        // Elements
        const titleEl = document.getElementById('title');
        const descEl = document.getElementById('desc');
        const metaEl = document.getElementById('meta');
        const serverJsonEl = document.getElementById('serverJson');
        const tmdbJsonEl = document.getElementById('tmdbJson');
        const trailerContainer = document.getElementById('trailerContainer');
        const reviewsList = document.getElementById('reviewsList');
        const addReviewBtn = document.getElementById('addReviewBtn');
        const revScoreInput = document.getElementById('revScore');
        const authArea = document.getElementById('authArea');
        const searchInput = document.getElementById('searchInput');
        const searchYear = document.getElementById('searchYear');
        const searchBtn = document.getElementById('searchBtn');

        // Fetch wrapper with optional Authorization from localStorage
        async function apiFetch(path, options = {}) {
            const headers = options.headers || {};
            if (!headers['Content-Type'] && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            headers['Accept'] = 'application/json';
            const token = localStorage.getItem('token');
            if (token) headers['Authorization'] = 'Bearer ' + token;
            const resp = await fetch(path, {...options, headers});
            const text = await resp.text();
            let body = null;
            try { body = text ? JSON.parse(text) : null } catch(e){ body = text }
            if (!resp.ok) {
                const err = new Error('Request failed: ' + resp.status);
                err.body = body;
                throw err;
            }
            return body;
        }

        // Render auth area
        function renderAuth(){
            const token = localStorage.getItem('token');
            authArea.innerHTML = '';
            if (!token) {
                const loginBtn = document.createElement('button'); loginBtn.textContent='Login';
                loginBtn.onclick = ()=> location.href = '/login.html';
                const regBtn = document.createElement('button'); regBtn.textContent='Register';
                regBtn.onclick = ()=> location.href = '/register.html';
                authArea.appendChild(loginBtn);
                authArea.appendChild(regBtn);
            } else {
                const outBtn = document.createElement('button'); outBtn.textContent='Logout';
                outBtn.onclick = ()=> { localStorage.removeItem('token'); renderAuth(); alert('Logged out'); }
                authArea.appendChild(outBtn);
            }
        }
        renderAuth();

        // Search button
        searchBtn.addEventListener('click', ()=>{
            const q = searchInput.value.trim();
            const y = searchYear.value.trim();
            const url = '/movie.html' + (q || y ? ('?title=' + encodeURIComponent(q) + (y ? '&year='+encodeURIComponent(y):'')) : '');
            location.href = url;
        });

        // If params contain title (from search page), redirect to index or do search:
        const searchTitleParam = qs('title');

        if (searchTitleParam !== null) {
            // redirect to / (index) with client-side app expected OR use API search and display list
            // We'll do a simple client-side list from /api/movies/search or fallback
            // Build a simple list instead of detail
            document.title = 'Search: ' + searchTitleParam;
            titleEl.textContent = 'Search results for: ' + searchTitleParam;
            descEl.textContent = '';
            metaEl.textContent = '';
            // Hide trailer and tmdb blocks
            trailerContainer.innerHTML = '';
            tmdbJsonEl.textContent = '';
            serverJsonEl.textContent = '';

            // Fetch search
            (async function doSearch(){
                try {
                    let url = '/api/movies/search?title=' + encodeURIComponent(searchTitleParam);
                    if (qs('year')) url += '&year=' + encodeURIComponent(qs('year'));
                    let data;
                    try {
                        data = await apiFetch(url);
                    } catch(e){
                        // fallback to all movies
                        data = await apiFetch('/api/movies');
                        data = data.filter(m => m.title && m.title.toLowerCase().includes(searchTitleParam.toLowerCase()));
                    }
                    const root = document.getElementById('movieMain');
                    root.innerHTML = '<h2>Search results</h2>';
                    if (!data || data.length === 0) {
                        root.innerHTML += '<p>No movies</p>';
                        return;
                    }
                    const list = document.createElement('div');
                    data.forEach(m => {
                        const el = document.createElement('div');
                        el.className = 'card';
                        el.innerHTML = `
            <h3>${m.title} <span class="small">(${m.year || ''})</span></h3>
            <div class="meta">Rating: ${m.rating || 0}</div>
            <div style="margin-top:8px">${m.description ? m.description.slice(0,150) : ''}</div>
            <div style="margin-top:8px"><a class="link" href="/movie.html?id=${m.id}">Open</a></div>
          `;
                        list.appendChild(el);
                    });
                    root.appendChild(list);
                } catch(err) {
                    console.error(err);
                    alert('Search failed');
                }
            })();
            return; // stop further detail loading
        }

        // If no params: try to show message
        if (!serverId && !tmdbParam) {
            titleEl.textContent = 'No movie specified';
            descEl.textContent = 'Open this page with ?id=<server id> or ?tmdb=<tmdb id>';
            trailerContainer.innerHTML = '';
            serverJsonEl.textContent = '';
            tmdbJsonEl.textContent = '';
            reviewsList.innerHTML = '';
            return;
        }

        // Load by server id first if provided
        let serverMovie = null;
        if (serverId) {
            try {
                serverMovie = await apiFetch('/api/movies/' + encodeURIComponent(serverId));
                titleEl.textContent = serverMovie.title || 'Untitled';
                descEl.textContent = serverMovie.description || '';
                metaEl.textContent = 'Year: ' + (serverMovie.year || 'N/A') + ' • Rating: ' + (serverMovie.rating || 0);
                serverJsonEl.textContent = toJsonText(serverMovie);
            } catch(e) {
                titleEl.textContent = 'Movie not found';
                descEl.textContent = '';
                serverJsonEl.textContent = '';
                console.error(e);
            }
        }

        // Determine tmdb id:
        let tmdbId = tmdbParam || (serverMovie && (serverMovie.tmdb_id || serverMovie.TMDBID || serverMovie.tmdbId));
        // If still no tmdb id but tmdbParam present, use it; else leave undefined

        // Fetch TMDB metadata & trailer if tmdbId exists
        let tmdbData = null;
        if (tmdbId) {
            try {
                tmdbData = await apiFetch('/api/tmdb/movies/' + encodeURIComponent(tmdbId));
                tmdbJsonEl.textContent = toJsonText(tmdbData);
            } catch(e){
                console.warn('TMDB fetch failed', e);
                tmdbJsonEl.textContent = 'TMDB fetch failed: ' + (e.body ? JSON.stringify(e.body) : e.message || e);
            }
        } else {
            tmdbJsonEl.textContent = 'No TMDB id available';
        }

        // Render trailer if present in tmdbData
        function renderTrailerFromTmdb(t) {
            trailerContainer.innerHTML = '';
            if (!t || !t.trailer_url) {
                trailerContainer.innerHTML = '<div class="small">No trailer available</div>';
                return;
            }
            const u = t.trailer_url;
            // Extract video id (youtube)
            let vid = null;
            if (u.includes('v=')) {
                vid = u.split('v=')[1];
                // remove additional params
                if (vid.includes('&')) vid = vid.split('&')[0];
            } else {
                // last path segment
                const parts = u.split('/');
                vid = parts[parts.length-1];
            }
            if (!vid) {
                trailerContainer.innerHTML = '<div class="small">Trailer URL present but cannot parse video id</div>';
                return;
            }
            const iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '200';
            iframe.src = 'https://www.youtube.com/embed/' + vid;
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.setAttribute('allowfullscreen', '');
            trailerContainer.appendChild(iframe);
        }
        renderTrailerFromTmdb(tmdbData);

        // Load reviews if serverId present
        async function loadReviews() {
            reviewsList.innerHTML = 'Loading...';
            if (!serverId) { reviewsList.innerHTML = '<div class="small">No server ID, cannot load reviews</div>'; return; }
            try {
                const revs = await apiFetch('/api/movies/' + encodeURIComponent(serverId) + '/reviews');
                if (!revs || revs.length === 0) {
                    reviewsList.innerHTML = '<div class="small">No reviews yet</div>';
                    return;
                }
                reviewsList.innerHTML = '';
                revs.forEach(r => {
                    const el = document.createElement('div');
                    el.className = 'review';
                    el.innerHTML = `<div><strong>User ${r.userId || r.user_id}</strong> • <span class="small"> ${new Date(r.createdAt||r.created_at).toLocaleString()}</span></div>
                        <div>Score: ${r.score}</div>
                        <div>${r.text || ''}</div>`;
                    reviewsList.appendChild(el);
                });
            } catch(e) {
                console.error(e);
                reviewsList.innerHTML = '<div class="small">Failed to load reviews</div>';
            }
        }
        await loadReviews();

        // Add review
        addReviewBtn.onclick = async function(){
            if (!serverId) { alert('No server movie id'); return; }
            const token = localStorage.getItem('token');
            if (!token) { alert('You must be logged in to add a review'); location.href = '/login.html'; return; }
            const score = Math.max(1, Math.min(5, parseInt(revScoreInput.value || 5)));
            try {
                await apiFetch('/api/movies/' + encodeURIComponent(serverId) + '/reviews', {
                    method: 'POST',
                    body: JSON.stringify({ userId: 0, score }) // server expects model.Review containing userId (server should override with token user)
                });
                alert('Review added');
                await loadReviews();
            } catch(e) {
                console.error(e);
                alert('Failed to add review: ' + (e.body?.error || e.message));
            }
        };

    })();
</script>
</body>
</html>
